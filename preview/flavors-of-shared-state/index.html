<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>Flavors of shared state in Cats Effect</title>
    <meta name="description" content="In this post, we will explore the various ways to share state in a Cats Effect application.">

    <link rel="stylesheet" href="https://blog.kubukoz.com/preview/main.css">
    <link rel="stylesheet" href="https://blog.kubukoz.com/preview/custom.css">
    <link rel="icon" type="image/x-icon" href="/images/favicon.svg">

    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://blog.kubukoz.com/preview/atom.xml">
    

    
    
</head>
<body>
    
    <a class="skip-main" href="#main">Skip to content</a>
    <div class="container">
        <header>
            <h1 class="site-header">
                <a href="https:&#x2F;&#x2F;blog.kubukoz.com&#x2F;preview">Jakub Koz≈Çowski</a> | A 1.00000000000001x engineering blog
            </h1>
            <nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;blog.kubukoz.com&#x2F;preview&#x2F;talks&#x2F;">Talks</a>
                
                
            </nav>
        </header>
        <div class="search-container">
            <input id="searchbox" type="search" placeholder="Search">
            <div class="search-results">
                <div class="search-results__items">
                </div>
            </div>
        </div>
        <main id="main" tabindex="-1">
            

<article class="post">
    <header>
        <h1>Flavors of shared state in Cats Effect</h1>
    </header>
    <div class="content">
        <p>In this post, we will explore the various ways to share state in a <a rel="noopener" target="_blank" href="https://typelevel.org/cats-effect">Cats Effect</a> application.</p>
<span id="continue-reading"></span><h1 id="introduction-why-do-we-need-shared-state"><a class="zola-anchor" href="#introduction-why-do-we-need-shared-state" aria-label="Anchor link for: introduction-why-do-we-need-shared-state">Introduction: why do we need shared state?</a></h1>
<p>One may think that Functional Programming eliminates the need for shared state altogether - however, sooner or later, we have to interact with the so called &quot;Real World&quot;. Turns out, the world is <del>a JoJo reference</del> a stateful thing, so interacting with it requires some form of <a rel="noopener" target="_blank" href="https://typelevel.org/cats-effect/docs/concepts#effects">effects</a>.</p>
<p>As if that wasn't enough, sometimes we want to keep some state in our own application: even something like a &quot;request counter&quot;, which keeps a running total of the requests handled by the service, requires some form of shared in-memory state.</p>
<p>Then we have more complex concepts such as connections, resource pools, queues, rate limiters and so on, all of which are by nature stateful as well.
Let's take Cats Effect for a spin and see what tools we can use to build such mechanisms.</p>
<h2 id="working-example-simple-counter"><a class="zola-anchor" href="#working-example-simple-counter" aria-label="Anchor link for: working-example-simple-counter">Working example: simple counter</a></h2>
<p>Following the idea of a request counter, let's use this concept for our example.</p>
<p>Our counter will have two operations:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>effect<span class="z-punctuation z-accessor z-dot z-scala">.</span>IO</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> Counter</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">increment</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Unit</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">get</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre>
<h2 id="starting-simple-ref"><a class="zola-anchor" href="#starting-simple-ref" aria-label="Anchor link for: starting-simple-ref">Starting simple: <code>Ref</code></a></h2>
<p>First, we'll define a helper to reduce the boilerplate in our implementations:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">makeCounter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">inc</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Unit</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">retrieve</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-other z-scala">new</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">increment</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Unit</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> inc
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">get</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Int</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> retrieve
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Now let's try and implement the counter with our good old friend, <code>cats.effect.kernel.Ref</code>.</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> conveniently aliased</span>
</span><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>effect<span class="z-punctuation z-accessor z-dot z-scala">.</span>Ref</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">refCounter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Ref</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">ref</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  makeCounter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>update<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> + <span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>get
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>We can now instantiate such a counter and use it, including in concurrent scenarios:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>implicits<span class="z-punctuation z-accessor z-dot z-scala">.</span>*</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">useCounter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span><span class="z-source z-scala">  <span class="z-variable z-parameter z-scala">counter</span> <span class="z-keyword z-operator z-assignment z-scala">&lt;-</span> refCounter
</span><span class="z-source z-scala">  <span class="z-variable z-language z-underscore z-scala">_</span>       <span class="z-keyword z-operator z-assignment z-scala">&lt;-</span> counter<span class="z-punctuation z-accessor z-scala">.</span>increment<span class="z-punctuation z-accessor z-scala">.</span>parReplicateA<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">2</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala">  <span class="z-variable z-parameter z-scala">v</span>       <span class="z-keyword z-operator z-assignment z-scala">&lt;-</span> counter<span class="z-punctuation z-accessor z-scala">.</span>get
</span><span class="z-source z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> v
</span></code></pre>
<p>Let's see what that gives us:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>effect<span class="z-punctuation z-accessor z-dot z-scala">.</span>unsafe<span class="z-punctuation z-accessor z-dot z-scala">.</span>implicits<span class="z-punctuation z-accessor z-dot z-scala">.</span>*</span>
</span><span class="z-source z-scala">useCounter<span class="z-punctuation z-accessor z-scala">.</span>unsafeRunSync<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> res0: Int = 2</span>
</span></code></pre>
<p>Clearly, some sharing happened: the value was updated twice!</p>
<p>What are the characteristics of this counter?</p>
<ul>
<li>It can be atomically updated from multiple fibers</li>
<li>The count is shared everywhere within the scope where the counter is visible, i.e. within the for comprehension.</li>
</ul>
<p>That makes it suitable for a counter of all requests an application has received while it's up. However, let's imagine we need some more isolation: let's try to count all <em>client requests</em> that we've made while handling a <em>server request</em>.</p>
<p>We'll make the simplest client call possible:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> org<span class="z-punctuation z-accessor z-dot z-scala">.</span>http4s<span class="z-punctuation z-accessor z-dot z-scala">.</span>*</span>
</span><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> org<span class="z-punctuation z-accessor z-dot z-scala">.</span>http4s<span class="z-punctuation z-accessor z-dot z-scala">.</span>client<span class="z-punctuation z-accessor z-dot z-scala">.</span>Client</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">sampleRequest</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-storage z-type z-primitive z-scala">Unit</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> client<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Request</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>use_
</span></code></pre>
<p>and our request handler may look like this (with http4s):</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-parameter z-scala">req</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">      <span class="z-support z-constant z-scala">IO</span><span class="z-punctuation z-accessor z-scala">.</span>pure<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Can we use <code>refCounter</code> for this purpose? Sure, why not. We'll increment before the request, to avoid dealing with error handling. We'll also return the final value in the response:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-parameter z-scala">req</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    refCounter<span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala"> <span class="z-variable z-parameter z-scala">c</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      c<span class="z-punctuation z-accessor z-scala">.</span>increment *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        c<span class="z-punctuation z-accessor z-scala">.</span>increment *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Let's try it out:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">testRoute</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">route</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-arrow z-scala">=&gt;</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">List</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">String</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> our fake client, which simply succeeds</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">c</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Client</span><span class="z-punctuation z-accessor z-scala">.</span>fromHttpApp<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">HttpApp</span><span class="z-punctuation z-accessor z-scala">.</span>pure<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> build the route: the &quot;IO&quot; part will be useful later</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  route<span class="z-punctuation z-section z-group z-begin z-scala">(</span>c<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">handler</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> run the route with a simple request and grab its body</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">runAndGetBody</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> handler<span class="z-punctuation z-accessor z-scala">.</span>orNotFound<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Request</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>bodyText<span class="z-punctuation z-accessor z-scala">.</span>compile<span class="z-punctuation z-accessor z-scala">.</span>string<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Run the request 10 times in parallel</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    runAndGetBody
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-punctuation z-accessor z-scala">.</span>parReplicateA<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">10</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> validate results</span>
</span><span class="z-source z-scala"><span class="z-punctuation z-accessor z-scala">.</span>flatTap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-parameter z-scala">results</span> <span class="z-keyword z-control z-flow z-scala">if</span></span> results<span class="z-punctuation z-accessor z-scala">.</span>forall<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> <span class="z-keyword z-operator z-comparison z-scala">==</span> <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">&quot;</span>2<span class="z-punctuation z-definition z-string z-end z-scala">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-support z-constant z-scala">IO</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">&quot;</span>Success!<span class="z-punctuation z-definition z-string z-end z-scala">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">  </span><span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-parameter z-scala">results</span>                             </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-non-first z-scala"> <span class="z-support z-constant z-scala">IO</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>println<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">&quot;</span>Failure!<span class="z-punctuation z-definition z-string z-end z-scala">&quot;</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-non-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala">testRoute<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span> <span class="z-support z-constant z-scala">IO</span><span class="z-punctuation z-accessor z-scala">.</span>pure<span class="z-punctuation z-section z-group z-begin z-scala">(</span>routes<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>unsafeRunSync<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Success!</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> res2: List[String] = List(&quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;)</span>
</span></code></pre>
<p>It... does work. Notably, we can't put the <code>refCounter.flatMap</code> part outside of our router, as that'd make the counter shared across all requests: remember, we wanted to isolate the counts of each request we handle.</p>
<p>Let's hide the increments in a client middleware, to declutter the code a bit:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">withCount</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">counter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Client</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">req</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  counter<span class="z-punctuation z-accessor z-scala">.</span>increment<span class="z-punctuation z-accessor z-scala">.</span>toResource *&gt;
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    client<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span>req<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Now here's the updated routing code:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    refCounter<span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala"> <span class="z-variable z-parameter z-scala">c</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">countedClient</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> withCount<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-separator z-scala">,</span> c<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>countedClient<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>countedClient<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>It still feels cluttered, doesn't it? Also, that's probably the most obvious problem with our example - but there's an even more serious one that's likely to bite us when we try to build something real. Let's discuss that.</p>
<p>In our example, the client calls are happening directly in the route (the request handler). However, in a real application it's very likely to be wrapped in at least one layer of abstraction: this could be a <code>UserService</code>, which would in turn use a <code>UserClient</code>, which would be the one actually using <code>Client</code>.</p>
<p>It might look a little like this:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">userService</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">UserService</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">POST</span> -&gt; <span class="z-support z-constant z-scala">Root</span> / <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">&quot;</span>users<span class="z-punctuation z-definition z-string z-end z-scala">&quot;</span></span> / <span class="z-variable z-parameter z-scala">id</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    userService<span class="z-punctuation z-accessor z-scala">.</span>find<span class="z-punctuation z-section z-group z-begin z-scala">(</span>id<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">None</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-support z-constant z-scala">NotFound</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">      </span><span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">u</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-non-first z-scala"> userService<span class="z-punctuation z-accessor z-scala">.</span>notify<span class="z-punctuation z-section z-group z-begin z-scala">(</span>u<span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">SubscriptionExpired</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt; <span class="z-support z-constant z-scala">NoContent</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-non-first z-scala">    </span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>In such a design, the http4s <code>Client</code> is nowhere to be seen - it's encapsulated in the definition of <code>UserService</code> (and possibly even further). How do we tell it about the counter, then? Do we add a <code>Counter</code> parameter to all the methods of <code>UserService</code> and its dependencies, all the way until we have access to the http4s <code>Client</code>?</p>
<p>Well, that'd work, but it'd certainly go against the point of all this abstraction. Surely we can find something else.</p>
<p>All we need is to propagate the <code>Counter</code> from our request handler to the client. If this sounds to you like a <code>Reader</code> monad, that's certainly one tool to achieve this! However, we're not always going to be able to use it:</p>
<ul>
<li>it implies that <code>UserService</code>'s methods have a reader monad in their return types
<ul>
<li>this means that we either use polymorphic effects (AKA Tagless Final), or hardcode the exact reader monad with the exact type of context that we we need (<code>Counter</code>)</li>
</ul>
</li>
<li>this approach is still &quot;viral&quot;, i.e. it infects the interfaces of not only <code>UserService</code>, but also its peers (the <code>UserClient</code> mentioned earlier)</li>
</ul>
<p>So let's not do that here. If we're not going to pass the counter as parameters (or a reader monad), could we inject the counter to the <code>UserService</code> at construction time, then?</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">mkUserService</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span> <span class="z-keyword z-operator z-arrow z-scala">=&gt;</span> <span class="z-support z-class z-scala">UserService</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">POST</span> -&gt; <span class="z-support z-constant z-scala">Root</span> / <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">&quot;</span>users<span class="z-punctuation z-definition z-string z-end z-scala">&quot;</span></span> / <span class="z-variable z-parameter z-scala">id</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    refCounter<span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span></span></span><span class="z-meta z-block z-scala"> <span class="z-variable z-parameter z-scala">counter</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">userService</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> mkUserService<span class="z-punctuation z-section z-group z-begin z-scala">(</span>counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      userService<span class="z-punctuation z-accessor z-scala">.</span>find<span class="z-punctuation z-section z-group z-begin z-scala">(</span>id<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">        <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">None</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala"> <span class="z-support z-constant z-scala">NotFound</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">        </span><span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-support z-constant z-scala">Some</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">u</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-non-first z-scala"> userService<span class="z-punctuation z-accessor z-scala">.</span>notify<span class="z-punctuation z-section z-group z-begin z-scala">(</span>u<span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">SubscriptionExpired</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt; <span class="z-support z-constant z-scala">NoContent</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-non-first z-scala">      </span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Looks like we can. However, this is a bit of a code smell: the fact that <code>UserService</code> depends (indirectly) on the counter is now visible to our routing. In addition, whenever we receive a request, we have to construct not only a <code>UserService</code>, but also every component that carries the <code>Counter</code> dependency. We'd have to measure the performance impact of such allocations on the hot path, and it'd certainly have severe implications if any of these components are stateful themselves.</p>
<p>We won't be doing that, then. So what are our demands?</p>
<ul>
<li>The counter dependency should be hidden from intermediate layers of abstraction (only the client and router need to know about it)</li>
<li>The counter's state should be isolated between requests, including concurrent ones.</li>
</ul>
<p>Readers with Java experience may recognize this as something similar to <code>ThreadLocal</code>. However, in Cats Effect we can't simply use a <code>ThreadLocal</code>, because due to its <a rel="noopener" target="_blank" href="https://typelevel.org/cats-effect/docs/thread-model">fiber-based concurrency model</a>, a single request may be processed on any number of threads (and on non-JVM platforms like Scala.js, we might only have one thread to begin with).</p>
<p>What we need is more of a... &quot;fiber&quot; local.</p>
<h2 id="isolated-state-with-iolocal"><a class="zola-anchor" href="#isolated-state-with-iolocal" aria-label="Anchor link for: isolated-state-with-iolocal">Isolated state with <code>IOLocal</code></a></h2>
<p>Cats Effect provides an <code>IOLocal</code>. It does exactly what we want! Let's implement the counter with it:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>effect<span class="z-punctuation z-accessor z-dot z-scala">.</span>IOLocal</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">localCounter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">IOLocal</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">ref</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  makeCounter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>update<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> + <span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>get
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>Now, we can create one <code>IOLocal</code>-backed Counter for our entire application, and share it.
As a good practice we'll reset each counter after each server request finishes processing (just in case any fibers are recycled between serial requests), but in reality it's likely that we'll just get a new fiber for each request.</p>
<p>For this, we'll need to enhance our definition of <code>localCounter</code> with the ability to reset it after we're done. I'm choosing to do this by composition, although inheritance could also be a reasonable choice:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>~&gt;</span>
</span><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>effect<span class="z-punctuation z-accessor z-dot z-scala">.</span>Resource</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">case </span><span class="z-storage z-type z-class z-scala">class</span><span class="z-entity z-name z-class z-scala"> CounterWithReset</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">withFreshCounter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span> <span class="z-support z-type z-scala">~&gt;</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">localCounterR</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">CounterWithReset</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">IOLocal</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">ref</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">c</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> makeCounter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>update<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> + <span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    ref<span class="z-punctuation z-accessor z-scala">.</span>get
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-support z-constant z-scala">CounterWithReset</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>c<span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">Resource</span><span class="z-punctuation z-accessor z-scala">.</span>make<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">IO</span><span class="z-punctuation z-accessor z-scala">.</span>unit<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span> ref<span class="z-punctuation z-accessor z-scala">.</span>reset<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>surroundK<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>We'll also need to enhance our router so that it actually resets the local. Let's make another middleware:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>data<span class="z-punctuation z-accessor z-dot z-scala">.</span>Kleisli</span>
</span><span class="z-source z-scala"><span class="z-meta z-import z-scala"><span class="z-keyword z-other z-import z-scala">import</span> cats<span class="z-punctuation z-accessor z-dot z-scala">.</span>data<span class="z-punctuation z-accessor z-dot z-scala">.</span>OptionT</span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">withCountReset</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">r</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">CounterWithReset</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Kleisli</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">req</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-support z-constant z-scala">OptionT</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    c<span class="z-punctuation z-accessor z-scala">.</span>withFreshCounter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>r<span class="z-punctuation z-accessor z-scala">.</span>run<span class="z-punctuation z-section z-group z-begin z-scala">(</span>req<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>value<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>If you want to be more concise:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">withCountReset</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">r</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">CounterWithReset</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span><span class="z-source z-scala">  r<span class="z-punctuation z-accessor z-scala">.</span>mapF<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>mapK<span class="z-punctuation z-section z-group z-begin z-scala">(</span>c<span class="z-punctuation z-accessor z-scala">.</span>withFreshCounter<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre>
<p>Now we're armed and we can get to the action:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">appR</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">rawClient</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span><span class="z-source z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 1</span>
</span><span class="z-source z-scala">  localCounterR<span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">counterWithReset</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">counter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> counterWithReset<span class="z-punctuation z-accessor z-scala">.</span>c
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 2</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">client</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> withCount<span class="z-punctuation z-section z-group z-begin z-scala">(</span>rawClient<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 3</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">r</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> routes<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 4.</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    withCountReset<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">      r<span class="z-punctuation z-separator z-scala">,</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">      counterWithReset
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> *&gt;
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">      c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>And we've achieved our desired goal! To sum up, here's what's happening:</p>
<ol>
<li>We create an <code>IOLocal</code>-based counter and open a scope of sharing by mapping on it. The resultant <code>IO</code> can be flatMapped on directly in your IOApp, as soon as you have a Client. If you only <code>flatMap</code> once, you'll have a globally-shared <code>IOLocal</code> (which is likely what you want).</li>
<li>We wrap the &quot;real&quot; http4s Client with middleware that increments the count before sending any request.</li>
<li>We pass the wrapped client to the routes. In the <code>UserService</code> example above, at this point we could deal with the construction of any <code>UserService</code> dependencies, and it'd only happen once, instead of on every request.</li>
<li>We wrap the routes in middleware that resets the counter after processing each request.</li>
</ol>
<p>Let's test that as well:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala">testRoute<span class="z-punctuation z-section z-group z-begin z-scala">(</span>appR<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>unsafeRunSync<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Success!</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> res7: List[String] = List(&quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;)</span>
</span></code></pre>
<p>So... is that it? Well, sort of.</p>
<h2 id="child-fibers"><a class="zola-anchor" href="#child-fibers" aria-label="Anchor link for: child-fibers">Child fibers</a></h2>
<p>In our desire to share the <code>Counter</code> instance across the entire app, we've forgotten something important: we actually want some isolation. And yes, we do have isolation between the requests being processed by the application, but what if the request itself is split into multiple fibers?</p>
<p>What if the route actually looks like this?</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routes</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> &amp;&gt;
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">    <span class="z-punctuation z-section z-group z-end z-scala">)</span></span> *&gt; c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>It's a critical difference: the two requests will now be executed in parallel. Because <code>IOLocal</code> doesn't propagate changes from a child fiber to its parent, the global counter will now be unaffected by anything that's been forked! This could be a problem. And it is!</p>
<details style="background-color: #eee">
<summary style="display: list-item">Some boilerplate to prepare for that test run</summary>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">appRWithParallel</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">rawClient</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span><span class="z-source z-scala">  localCounterR<span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">counterWithReset</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">counter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> counterWithReset<span class="z-punctuation z-accessor z-scala">.</span>c
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">client</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> withCount<span class="z-punctuation z-section z-group z-begin z-scala">(</span>rawClient<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">r</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> routesWithParallel<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    withCountReset<span class="z-punctuation z-section z-group z-begin z-scala">(</span>r<span class="z-punctuation z-separator z-scala">,</span> counterWithReset<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routesWithParallel</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> &amp;&gt;
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">    <span class="z-punctuation z-section z-group z-end z-scala">)</span></span> *&gt; c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
</details>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala">testRoute<span class="z-punctuation z-section z-group z-begin z-scala">(</span>appRWithParallel<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>unsafeRunSync<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Failure!</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> res9: List[String] = List(&quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;)</span>
</span></code></pre>
<p>Here's the thing: <code>Ref</code> didn't care about the fibers' family drama. If only we could pick and choose which parts of <code>IOLocal</code> and <code>Ref</code> we get...</p>
<p>Well, why don't we? Why don't we put a <code>Ref</code> inside <code>IOLocal</code>? Let's ponder:</p>
<p><code>IOLocal[A]</code> ensures that updates of <code>A</code> are not propagated to parent/child fibers. This can be done without inspecting the internals of the <code>A</code> value, by relying on its immutability to avoid sharing changes.</p>
<p>If <code>A</code> contains mutable state (which <code>Ref</code> pretty much is), you could mutate that state without ever calling <code>update</code> on the <code>IOLocal</code>... and it'll be visible in all offspring of the fiber that inserted that value.</p>
<p>Here's what this trick would look like: we can use <code>CounterWithReset</code> to encapsulate the &quot;swapping&quot; of the Ref for each request:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">localRefCounter</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">CounterWithReset</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span><span class="z-source z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 1</span>
</span><span class="z-source z-scala">  <span class="z-support z-constant z-scala">Ref</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">IOLocal</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">local</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 2</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">c</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> makeCounter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">      local<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>update<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> + <span class="z-constant z-numeric z-integer z-decimal z-scala">1</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-separator z-scala">,</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">      local<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 3</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">withFreshK</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Resource</span><span class="z-punctuation z-accessor z-scala">.</span>make<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Ref</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-constant z-numeric z-integer z-decimal z-scala">0</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>flatMap<span class="z-punctuation z-section z-group z-begin z-scala">(</span>local<span class="z-punctuation z-accessor z-scala">.</span>set<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span> local<span class="z-punctuation z-accessor z-scala">.</span>reset<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>surroundK
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> 4</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-support z-constant z-scala">CounterWithReset</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>c<span class="z-punctuation z-separator z-scala">,</span> withFreshK<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
<p>This may be a lot to take, so let's go through the steps one by one:</p>
<ol>
<li>We create a <code>Ref</code> as an initial value for the <code>IOLocal</code>. You could avoid this by making the <code>IOLocal</code> store an <code>Option[Ref]</code>, but I figured this would make it easier to implement the other parts. That <code>Ref</code> is immediately used to create the <code>IOLocal</code>.</li>
<li>We make a <code>Counter</code> instance based on the composed <code>IOLocal</code> and <code>Ref</code>. Neither of the methods of the counter actually update the Local: they both read from it and then behave just like a normal <code>Ref</code>-based counter would.</li>
<li>Before each request, we'll create a fresh <code>Ref</code> and put it into the Local. Afterwards, we'll reset the Local to its previous state, for good measure.</li>
<li>Finally, we return the counter with its reset button.</li>
</ol>
<p>The usage of <code>localRefCounter</code> is identical to that of <code>localCounterR</code>.</p>
<details style="background-color: #eee">
<summary style="display: list-item">Some boilerplate to prepare for that test run</summary>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">appRWithParallelAndRef</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">rawClient</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span><span class="z-source z-scala">  localRefCounter<span class="z-punctuation z-accessor z-scala">.</span>map <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">counterWithReset</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=&gt;</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">counter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> counterWithReset<span class="z-punctuation z-accessor z-scala">.</span>c
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">client</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> withCount<span class="z-punctuation z-section z-group z-begin z-scala">(</span>rawClient<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">r</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> routesWithParallelAndRef<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-separator z-scala">,</span> counter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    withCountReset<span class="z-punctuation z-section z-group z-begin z-scala">(</span>r<span class="z-punctuation z-separator z-scala">,</span> counterWithReset<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">routesWithParallelAndRef</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">client</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Client</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">c</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Counter</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">HttpRoutes</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">HttpRoutes</span><span class="z-punctuation z-accessor z-scala">.</span>of<span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">IO</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-keyword z-other z-declaration z-scala">case</span><span class="z-meta z-pattern z-scala"> <span class="z-variable z-language z-underscore z-scala">_</span> </span><span class="z-storage z-type z-function z-arrow z-case z-scala">=&gt;</span><span class="z-meta z-block z-case z-first z-scala">
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala">    <span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span> &amp;&gt;
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">      sampleRequest<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"><span class="z-meta z-group z-scala">    <span class="z-punctuation z-section z-group z-end z-scala">)</span></span> *&gt; c<span class="z-punctuation z-accessor z-scala">.</span>get<span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-accessor z-scala">.</span>show<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>map<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Response</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>withEntity<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-case z-first z-scala"></span><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre>
</details>
<p>Does it resolve the issue?</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala">testRoute<span class="z-punctuation z-section z-group z-begin z-scala">(</span>appRWithParallelAndRef<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-accessor z-scala">.</span>unsafeRunSync<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Success!</span>
</span><span class="z-source z-scala"><span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> res10: List[String] = List(&quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;, &quot;2&quot;)</span>
</span></code></pre>
<p>Apparently, it does!</p>
<h2 id="what-about-the-opposite"><a class="zola-anchor" href="#what-about-the-opposite" aria-label="Anchor link for: what-about-the-opposite">What about the opposite?</a></h2>
<p>Perhaps you were wondering if we can flip the order of &quot;state carriers&quot; around and have <code>Ref[IO, IOLocal[A]]</code>. I would be inclined to say no, because the standard <code>Ref</code> implementation relies on a CAS (compare and set) loop for its updates, and that might not play well with how <code>IOLocal</code> is implemented. However, you're welcome to try... in a controlled environment :)</p>
<h2 id="can-we-go-deeper"><a class="zola-anchor" href="#can-we-go-deeper" aria-label="Anchor link for: can-we-go-deeper">Can we go deeper?</a></h2>
<p>We've established that with the composition of <code>IOLocal</code> and <code>Ref</code> we have more control over when we &quot;fork&quot; the scope of our state than if we were using either of them separately.</p>
<p>Just how much control are we talking, exactly?</p>
<p>Turns out, we can freely &quot;fork&quot; whenever we want - just like we do in <code>withFreshK</code> - it's just a matter of exposing such a feature through our counter's API.</p>
<pre data-lang="diff" class="language-diff z-code"><code class="language-diff" data-lang="diff"><span class="z-source z-diff">trait Counter {
</span><span class="z-source z-diff">  def increment: IO[Unit]
</span><span class="z-source z-diff">  def get: IO[Int]
</span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> def fork: IO ~&gt; IO
</span></span><span class="z-source z-diff">}
</span></code></pre>
<p>It's worth noting that at this point we cannot really implement a valid <code>Counter</code> based on just a <code>Ref</code> - by giving out API more power, we've constrained the number of valid implementations - <a rel="noopener" target="_blank" href="https://www.youtube.com/watch?v=GqmsQeSzMdw">constraints liberate, liberties constrain</a>.</p>
<p>Of course, if you want to control the value that forked counters will start with, you'll need to further adjust the API to account for that feature. This is left as <a rel="noopener" target="_blank" href="https://en.wikipedia.org/wiki/Small_matter_of_programming">an exercise for the reader</a>.</p>
<h3 id="trivia-natchez-s-trace-algebra"><a class="zola-anchor" href="#trivia-natchez-s-trace-algebra" aria-label="Anchor link for: trivia-natchez-s-trace-algebra">Trivia: Natchez's Trace algebra</a></h3>
<p><a rel="noopener" target="_blank" href="https://github.com/typelevel/natchez">The Natchez library</a>, which is used for distributed tracing, uses a similar idea in its <code>Trace</code> algebra:</p>
<pre data-lang="scala" class="language-scala z-code"><code class="language-scala" data-lang="scala"><span class="z-source z-scala"><span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">trait</span><span class="z-entity z-name z-class z-scala"> Trace</span></span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">F</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-underscore z-scala">_</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">span</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">name</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">String</span> <span class="z-comment z-block z-scala">/*, ... */</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">k</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">F</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> other methods here</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span></code></pre>
<p>Its two main implementations (based on <code>Kleisli</code> or <code>IOLocal</code>) both carry a <code>Span</code>, which is backed by mutable state - depending on the backend it's sometimes a <code>Ref</code>, sometimes a plain mutable object like an OpenTracing <code>Span</code>.</p>
<h2 id="comparison"><a class="zola-anchor" href="#comparison" aria-label="Anchor link for: comparison">Comparison</a></h2>
<p>We've explored a bunch of options for sharing state, with various degrees of isolation. Which one should <em>you</em> use?</p>
<p>It depends on the problem you're trying to solve. If your goal is to share the state for the entire application (for example, for a client's rate limiter), <code>Ref</code> will do just fine. If you want to prioritize isolation and avoid any race conditions, <code>IOLocal</code> may work well for you. However, if you want more precise control and the ability to &quot;disconnect&quot; from a more &quot;global&quot; state, it's likely that you'll want to wrap some mutable state in an <code>IOLocal</code> - such as a <code>Ref</code>.</p>
<p>Personally, I believe for most usecases in HTTP applications that desire &quot;reader monad&quot; semantics of state, <code>IOLocal</code> + <code>Ref</code> should be preferred over just <code>IOLocal</code>. Using the latter is likely to lead to subtle bugs, such as changes not being propagated upwards when a library down the call stack starts to involve concurrency.</p>
<p>I hope this article helps you make an informed decision. Thanks for reading!</p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date"> 1 March 2024</div>
        
        <div class="article-taxonomies">
            
            
                <ul class="article-tags">
                    
                    <li><a href="https://blog.kubukoz.com/preview/tags/scala/">#scala</a></li>
                    
                    <li><a href="https://blog.kubukoz.com/preview/tags/functional-programming/">#functional programming</a></li>
                    
                    <li><a href="https://blog.kubukoz.com/preview/tags/cats/">#cats</a></li>
                    
                </ul>
            
        </div>
    </div>

</article>


<div id="disqus_thread"></div>
<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */

  var disqus_config = function () {
    this.page.url = "https://blog.kubukoz.com/preview/flavors-of-shared-state?disqus_revision=1";
    this.page.identifier = '/flavors-of-shared-state?disqus_revision=1';
  };

  (function () {
    // DON'T EDIT BELOW THIS LINE
    var d = document,
      s = d.createElement("script");
    s.src = "https://kubukoz-blog.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
 
        </main>
        <footer>
            <p>
                ¬© Jakub Koz≈Çowski (<a href="https://twitter.com/kubukoz">@kubukoz</a>) 2024<br>
                Powered by <a target="_blank" href="https://getzola.org/">Zola</a>, Theme <a target="_blank" href="https://github.com/zbrox/anpu-zola-theme">Anpu</a>.
            </p>
            <p>
                
                
            </p>
        </footer>
    </div>
</body>
<!-- Google Analytics Tracking code -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55943015-8', 'auto');
    ga('send', 'pageview');

</script>
<script type="text/javascript" src="https://blog.kubukoz.com/preview/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://blog.kubukoz.com/preview/search_index.en.js"/></script>
<script type="text/javascript" src="https://blog.kubukoz.com/preview/search.js"/></script>
</html>
